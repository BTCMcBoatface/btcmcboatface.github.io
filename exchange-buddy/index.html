<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Bitcoin Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="htmx.min.js"></script>
    <link rel="stylesheet" href="converter-styles.css">
    <script src="bitsSymbol.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        .dual-columns { display: flex; gap: 2rem; }
        .column-title { font-weight: bold; text-align: center; margin-bottom: 0.5em; }
        .future-input-row { display: flex; align-items: center; gap: 0.5em; margin-bottom: 0.5em; }
        .future-label { font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="converter-container">
        <div class="header">
            <h1 class="converter-title">Bitcoin Converter</h1>
            <div class="currency-selector">
                <select id="currency-selector">
                    <option value="">Add Currency...</option>
                    <script>
                        fetch('currencies.json')
                            .then(response => response.json())
                            .then(data => {
                                const selector = document.getElementById('currency-selector');
                                data.currencies.forEach(currency => {
                                    const option = document.createElement('option');
                                    option.value = currency.code;
                                    option.textContent = currency.code;
                                    selector.appendChild(option);
                                });
                            });
                    </script>
                </select>
            </div>
        </div>

        <div style="margin: 1em 0;">
            <label>
                <input type="checkbox" id="show-future-checkbox">
                Show Future Prediction
            </label>
        </div>

        <div id="future-inputs-section" style="display: none; margin-bottom: 1em;">
            <div class="column-title">Set Your Future BTC Exchange Rates</div>
            <div id="future-exchange-rate-inputs"></div>
        </div>

        <div class="space-y-4">
            <div id="conversion-results" class="space-y-4">
                <!-- Dual Columns -->
                <div class="dual-columns" id="dual-columns">
                    <!-- Current Rates Column -->
                    <div id="current-column">
                        <div class="column-title">Current</div>
                        <div class="core-units" id="core-units-current">
                            <div class="input-group horizontal">
                                <label>₿ BTC</label>
                                <input 
                                    type="number" 
                                    step="0.00000001" 
                                    id="btc-input" 
                                    name="btc"
                                    inputmode="decimal"
                                >
                            </div>
                            <div class="input-group horizontal">
                                <label><i class="Bits-Symbol_tilt"></i> Bits</label>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    id="bits-input" 
                                    name="bits"
                                    inputmode="decimal"
                                >
                            </div>
                            <div class="input-group horizontal">
                                <label>⚡️ Sats</label>
                                <input 
                                    type="number" 
                                    step="1" 
                                    id="sats-input" 
                                    name="sats"
                                    inputmode="decimal"
                                >
                            </div>
                            <div class="input-group horizontal">
                                <label for="usd-input"></label>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    id="usd-input" 
                                    name="usd"
                                    inputmode="decimal"
                                >
                            </div>
                            <div id="fiat-inputs" class="space-y-4"></div>
                        </div>
                    </div>
                    <!-- Future Prediction Column (hidden by default) -->
                    <div id="future-column" style="display:none;">
                        <div class="column-title">Future</div>
                        <div class="core-units" id="core-units-future">
                            <div class="input-group horizontal">
                                <label>₿ BTC</label>
                                <input 
                                    type="number" 
                                    step="0.00000001" 
                                    id="btc-input-future" 
                                    name="btc-future"
                                    inputmode="decimal"
                                    disabled
                                >
                            </div>
                            <div class="input-group horizontal">
                                <label><i class="Bits-Symbol_tilt"></i> Bits</label>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    id="bits-input-future" 
                                    name="bits-future"
                                    inputmode="decimal"
                                    disabled
                                >
                            </div>
                            <div class="input-group horizontal">
                                <label>⚡️ Sats</label>
                                <input 
                                    type="number" 
                                    step="1" 
                                    id="sats-input-future" 
                                    name="sats-future"
                                    inputmode="decimal"
                                    disabled
                                >
                            </div>
                            <div class="input-group horizontal">
                                <label for="usd-input-future"></label>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    id="usd-input-future" 
                                    name="usd-future"
                                    inputmode="decimal"
                                    disabled
                                >
                            </div>
                            <div id="fiat-inputs-future" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="last-updated" id="last-updated"></div>
    </div>

    <script>
        let exchangeRates = {};
        let currencyMetadata = {};
        let activeCurrencies = new Set();
        let futureRates = {}; // { CAD: userInput, ... }

        // Load both exchange rates and currency metadata
        async function loadData() {
            try {
                // Load exchange rates
                const ratesResponse = await fetch('exchange-rates.json');
                const ratesData = await ratesResponse.json();
                exchangeRates = ratesData.rates;

                // Convert Unix timestamp to readable date
                const lastUpdated = new Date(ratesData.timestamp * 1000); // multiply by 1000 as JS uses milliseconds
                document.getElementById('last-updated').textContent = 
                    `Fiat exchange rates last updated: ${lastUpdated.toLocaleString()}`;

                // Load currency metadata
                const metadataResponse = await fetch('fiat-country-flags.json');
                const metadataData = await metadataResponse.json();
                
                // Load configured currencies
                const currenciesResponse = await fetch('currencies.json');
                const currenciesData = await currenciesResponse.json();
                
                // Convert array to object for easier lookup
                currencyMetadata = metadataData.currencies.reduce((acc, curr) => {
                    acc[curr.code] = curr;
                    return acc;
                }, {});

                // Populate currency selector with configured currencies
                populateCurrencySelector(currenciesData.currencies);
                initializeCoreUnits();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function populateCurrencySelector(configuredCurrencies) {
            const selector = document.getElementById('currency-selector');
            selector.innerHTML = '<option value="">Add fiat exchange rate</option>';
            
            // Sort the currencies alphabetically and filter out CAD
            const sortedCurrencies = [...configuredCurrencies]
                .filter(code => code !== 'CAD')
                .sort();
            
            sortedCurrencies.forEach(code => {
                if (currencyMetadata[code]) {
                    const currency = currencyMetadata[code];
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${currency.emoji} ${code} (${currency.symbol})`;
                    selector.appendChild(option);
                }
            });
        }

        function addCurrencyInput(currencyCode) {
            if (activeCurrencies.has(currencyCode)) return;
            
            const currency = currencyMetadata[currencyCode];
            if (!currency) return;

            // Add to current column
            const fiatInputs = document.getElementById('fiat-inputs');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group horizontal';
            inputGroup.dataset.currency = currencyCode;
            
            inputGroup.innerHTML = `
                <label>${currency.emoji} ${currencyCode} ${currency.symbol}</label>
                <input 
                    type="number" 
                    step="0.01" 
                    id="${currencyCode.toLowerCase()}-input" 
                    name="${currencyCode.toLowerCase()}"
                    inputmode="decimal"
                >
                <button type="button" class="remove-currency" onclick="removeCurrency('${currencyCode}')">×</button>
            `;
            
            fiatInputs.appendChild(inputGroup);

            // Add to future column
            const fiatInputsFuture = document.getElementById('fiat-inputs-future');
            const inputGroupFuture = document.createElement('div');
            inputGroupFuture.className = 'input-group horizontal';
            inputGroupFuture.dataset.currency = currencyCode;
            inputGroupFuture.innerHTML = `
                <label>${currency.emoji} ${currencyCode} ${currency.symbol}</label>
                <input 
                    type="number" 
                    step="0.01" 
                    id="${currencyCode.toLowerCase()}-input-future" 
                    name="${currencyCode.toLowerCase()}-future"
                    inputmode="decimal"
                    disabled
                >
                <button type="button" class="remove-currency" onclick="removeCurrency('${currencyCode}')">×</button>
            `;
            fiatInputsFuture.appendChild(inputGroupFuture);

            // Add to future exchange rate inputs section
            addFutureRateInput(currencyCode);

            activeCurrencies.add(currencyCode);
            
            // Add event listener for immediate conversion
            const input = inputGroup.querySelector('input');
            input.addEventListener('input', function(e) {
                if (e.target.value !== '') {
                    convertFromSource(currencyCode.toLowerCase(), parseFloat(e.target.value));
                }
            });

            // Trigger initial calculation using BTC value
            const btcInput = document.getElementById('btc-input');
            if (btcInput.value !== '') {
                convertFromSource('btc', parseFloat(btcInput.value));
            }
            savePreferences();
        }

        function addFutureRateInput(currencyCode) {
            const futureSection = document.getElementById('future-exchange-rate-inputs');
            if (document.getElementById(`future-rate-${currencyCode}`)) return; // Already exists

            const row = document.createElement('div');
            row.className = 'future-input-row';
            row.id = `future-rate-${currencyCode}`;
            const currency = currencyMetadata[currencyCode];
            row.innerHTML = `
                <span class="future-label">${currency.emoji} ${currencyCode}: </span>
                <input 
                    type="number"
                    id="future-input-${currencyCode}"
                    placeholder="e.g. 1000000"
                    step="any"
                    min="0"
                    style="width:110px;"
                >
                <span class="future-label">${currency.symbol} per 1 BTC</span>
            `;
            futureSection.appendChild(row);

            // Event to update and recalculate future column
            row.querySelector('input').addEventListener('input', function() {
                const rate = parseFloat(this.value);
                if (!isNaN(rate) && rate > 0) {
                    futureRates[currencyCode] = rate;
                } else {
                    delete futureRates[currencyCode];
                }
                updateFutureColumn();
            });
        }

        // Remove currency everywhere
        function removeCurrency(currency) {
            const elements = document.querySelectorAll(`[data-currency="${currency}"]`);
            elements.forEach(el => el.remove());
            // Remove from future exchange rate inputs section
            const futureRow = document.getElementById(`future-rate-${currency}`);
            if (futureRow) futureRow.remove();
            activeCurrencies.delete(currency);
            delete futureRates[currency];
            savePreferences();
            updateFutureColumn();
        }

        // Update the core units section to include USD with flag and symbol
        function initializeCoreUnits() {
            // Set up USD label in both columns
            const usdLabel = document.querySelector('label[for="usd-input"]');
            const usdLabelFuture = document.querySelector('label[for="usd-input-future"]');
            if (usdLabel && currencyMetadata['USD']) {
                const usdData = currencyMetadata['USD'];
                usdLabel.innerHTML = `${usdData.emoji} USD ${usdData.symbol}`;
            }
            if (usdLabelFuture && currencyMetadata['USD']) {
                const usdData = currencyMetadata['USD'];
                usdLabelFuture.innerHTML = `${usdData.emoji} USD ${usdData.symbol}`;
            }
            // Add CAD as default currency
            addCurrencyInput('CAD');
        }

        function convertFromSource(sourceType, value) {
            // First convert to BTC as our base unit
            let btcValue;
            const btcUsdRate = 1 / exchangeRates.BTC;

            // Convert input to BTC
            switch(sourceType) {
                case 'btc':
                    btcValue = value;
                    break;
                case 'bits':
                    btcValue = value / 1000000;
                    break;
                case 'sats':
                    btcValue = value / 100000000;
                    break;
                case 'usd':
                    btcValue = value / btcUsdRate;
                    break;
                default:
                    // Handle other fiat currencies
                    const sourceRate = exchangeRates[sourceType.toUpperCase()];
                    const usdValue = value / sourceRate;
                    btcValue = usdValue / btcUsdRate;
            }

            // Update all fields based on BTC value
            updateAllFields(btcValue, sourceType);
            updateFutureColumn(btcValue, sourceType);
        }

        function updateAllFields(btcValue, sourceType) {
            const btcUsdRate = 1 / exchangeRates.BTC;
            const usdValue = btcValue * btcUsdRate;

            // Update core units (skip the source field)
            if (sourceType !== 'btc') {
                document.getElementById('btc-input').value = btcValue.toLocaleString('en-US', {
                    minimumFractionDigits: 8,
                    maximumFractionDigits: 8
                });
            }
            if (sourceType !== 'bits') {
                document.getElementById('bits-input').value = (btcValue * 1000000).toFixed(2);
            }
            if (sourceType !== 'sats') {
                document.getElementById('sats-input').value = (btcValue * 100000000).toFixed(0);
            }
            if (sourceType !== 'usd') {
                document.getElementById('usd-input').value = usdValue.toFixed(2);
            }
            // Update all active fiat currencies
            activeCurrencies.forEach(currency => {
                if (currency.toLowerCase() !== sourceType) {
                    const rate = exchangeRates[currency];
                    const value = usdValue * rate;
                    const input = document.getElementById(`${currency.toLowerCase()}-input`);
                    if (input) {
                        input.value = value.toFixed(2);
                    }
                }
            });
        }

        // For the future column
        function updateFutureColumn(btcValueOverride = null, sourceType = null) {
            const showFuture = document.getElementById('show-future-checkbox').checked;
            if (!showFuture) return;

            // Determine BTC value (use override if given)
            let btcValue = btcValueOverride;
            if (btcValue == null) {
                // Try to get from BTC input
                btcValue = parseFloat(document.getElementById('btc-input').value) || 0;
            }

            // USD
            const futureUsdRate = futureRates['USD'] || (1 / exchangeRates.BTC);
            const usdValue = btcValue * futureUsdRate;
            document.getElementById('btc-input-future').value = btcValue.toLocaleString('en-US', {
                minimumFractionDigits: 8,
                maximumFractionDigits: 8
            });
            document.getElementById('bits-input-future').value = (btcValue * 1000000).toFixed(2);
            document.getElementById('sats-input-future').value = (btcValue * 100000000).toFixed(0);
            document.getElementById('usd-input-future').value = usdValue.toFixed(2);

            // All fiat currency fields
            activeCurrencies.forEach(currency => {
                const input = document.getElementById(`${currency.toLowerCase()}-input-future`);
                if (!input) return;
                const userRate = futureRates[currency];
                if (userRate && btcValue) {
                    input.value = (btcValue * userRate).toFixed(2);
                } else {
                    input.value = '';
                }
            });
        }

        function savePreferences() {
            const preferences = {
                activeCurrencies: Array.from(activeCurrencies)
            };
            localStorage.setItem('bitcoinConverterPrefs', JSON.stringify(preferences));
        }

        function loadPreferences() {
            const savedPrefs = localStorage.getItem('bitcoinConverterPrefs');
            if (savedPrefs) {
                const prefs = JSON.parse(savedPrefs);
                if (prefs.activeCurrencies) {
                    prefs.activeCurrencies.forEach(currency => {
                        if (currency !== 'CAD') {
                            addCurrencyInput(currency);
                        }
                    });
                }
            }
        }

        // Handle show future checkbox toggling
        document.addEventListener('DOMContentLoaded', function() {
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            }

            // Load saved preferences
            loadPreferences();

            loadData().then(() => {
                initializeCoreUnits();

                // Add event listeners for core unit inputs
                ['btc', 'bits', 'sats', 'usd'].forEach(unit => {
                    document.getElementById(`${unit}-input`).addEventListener('input', function(e) {
                        if (e.target.value !== '') {
                            convertFromSource(unit, parseFloat(e.target.value));
                        }
                    });
                });

                // Add currency selector handler
                document.getElementById('currency-selector').addEventListener('change', function(e) {
                    if (e.target.value) {
                        addCurrencyInput(e.target.value);
                        e.target.value = '';
                    }
                });

                // Show/Hide future column
                document.getElementById('show-future-checkbox').addEventListener('change', function() {
                    const checked = this.checked;
                    document.getElementById('future-column').style.display = checked ? '' : 'none';
                    document.getElementById('future-inputs-section').style.display = checked ? '' : 'none';
                    if (checked) {
                        updateFutureColumn();
                    }
                });

                // Update future column if user changes any input
                ['btc', 'bits', 'sats', 'usd'].forEach(unit => {
                    document.getElementById(`${unit}-input`).addEventListener('input', function() {
                        updateFutureColumn();
                    });
                });
            });
        });
    </script>   
</body>
</html>
